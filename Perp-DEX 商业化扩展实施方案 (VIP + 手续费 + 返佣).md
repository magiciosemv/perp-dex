这是一个详细的项目实施操作方案文档，旨在指导开发团队在现有 Prep-DEX 基础上完成商业化扩展。该文档侧重于**操作流程、逻辑定义与架构设计**，不包含具体代码片段。

------

# Perp-DEX 商业化扩展实施方案 (VIP + 手续费 + 返佣)

文档版本：v2.0

适用阶段：Day 8+ 扩展开发

核心目标：构建基于交易量的 VIP 等级体系（门槛 1000-8000 USD）、交易手续费管理及邀请返佣闭环系统。

------

## 1. 业务规则定义

### 1.1 VIP 等级体系 (VIP Tiers)

系统将基于用户**过去 30 天累积交易量（Volume）**自动判定等级。交易量计算公式为：`成交金额 (Amount) * 成交价格 (Price)`。

| **等级名称** | **交易量门槛 (30 Days)** | **费率折扣** | **实际手续费率 (BPS)** | **备注**     |
| ------------ | ------------------------ | ------------ | ---------------------- | ------------ |
| **VIP 0**    | < 1,000 USD              | 无折扣       | **10 bps (0.10%)**     | 默认初始等级 |
| **VIP 1**    | ≥ 1,000 USD              | 9 折         | **9 bps (0.09%)**      | 入门门槛     |
| **VIP 2**    | ≥ 2,000 USD              | 8 折         | **8 bps (0.08%)**      | 进阶门槛     |
| **VIP 3**    | ≥ 5,000 USD              | 6 折         | **6 bps (0.06%)**      | 核心用户     |
| **VIP 4**    | ≥ 8,000 USD              | 5 折         | **5 bps (0.05%)**      | 顶级用户     |

### 1.2 手续费分配机制

- **总手续费**：由买卖双方在成交时分别支付。
- **返佣比例**：若用户绑定了推荐人，**10%** 的手续费直接划转给推荐人。
- **项目收入**：剩余 **90%** (或无推荐人时的 100%) 划转至项目方金库地址。

### 1.3 邀请绑定规则

- **唯一性**：每个地址只能绑定一个推荐人。
- **不可篡改**：一旦绑定，无法更换或解除。
- **防刷机制**：用户不能绑定自己为推荐人。

------

## 2. 智能合约层实施方案 (Contract Layer)

### 2.1 存储结构升级

需要在 `ExchangeStorage` 中扩展以下状态变量：

1. **全局配置**：
   - `FeeReceiver`：项目方收款地址。
   - `ReferralRebateBps`：返佣比例配置（默认 10%）。
2. **VIP 配置**：
   - 映射表 `TierFeeBps`：记录 VIP 0 到 VIP 4 对应的具体费率值。
3. **用户状态**：
   - 映射表 `UserVipTier`：记录每个用户当前的 VIP 等级。
   - 映射表 `Referrers`：记录“用户 -> 推荐人”的绑定关系。

### 2.2 管理接口开发

需要在合约中实现以下管理功能：

1. **配置设置器**：允许管理员（Admin）修改基础费率、各等级优惠费率及返佣比例。
2. **等级设置器**：允许操作员（Operator/Keeper）修改特定用户的 VIP 等级。
3. **关系绑定器**：允许用户调用函数注册自己的推荐人。

### 2.3 核心撮合逻辑变更 (`_executeTrade`)

在撮合引擎执行交易时，需按以下顺序插入扣费逻辑（位于更新持仓之前）：

1. **读取等级**：获取交易者当前的 VIP 等级。
2. **计算应收费用**：根据等级对应的费率，计算名义价值的手续费。
3. **检查返佣**：
   - 查询交易者是否有上级推荐人。
   - 若有，计算 10% 返佣金额，直接增加推荐人的保证金余额。
   - 记录返佣支付事件。
4. **扣除费用**：
   - 从交易者保证金中扣除总手续费。
   - 将剩余部分（总费用 - 返佣）增加到项目方金库余额。
5. **记录事件**：发出 `FeeCharged` 事件，包含交易者、费用总额、返佣金额等信息。

------

## 3. 数据索引层实施方案 (Indexer Layer)

### 3.1 Schema 数据模型扩展

需要在 GraphQL Schema 中新增实体以支持前端查询和 Keeper 计算：

1. **UserVolume (用户交易量)**：
   - 字段：用户地址、统计周期（如按天/月）、累积交易量。
2. **ReferralStat (返佣统计)**：
   - 字段：推荐人地址、已邀请人数、累积已赚取佣金。

### 3.2 事件处理器开发 (Handlers)

1. **监听 `TradeExecuted`**：
   - 每当发生交易，更新 `UserVolume` 实体，累加该用户的交易量。
2. **监听 `ReferralRegistered`**：
   - 更新推荐人的“已邀请人数”计数。
3. **监听 `FeeCharged`**（或返佣事件）：
   - 更新推荐人的“累积已赚取佣金”数据。

------

## 4. 自动化服务实施方案 (Keeper Layer)

### 4.1 新增 VIP Keeper 服务

创建一个独立的 Keeper 进程，负责维护链下的等级计算与链上的状态同步。

### 4.2 执行逻辑流程

1. **定时触发**：设置定时任务（如每 1 小时或每天）。
2. **数据抓取**：
   - 向 Indexer 发起 GraphQL 查询。
   - 获取所有活跃用户在 `NOW - 30 Days` 期间的总交易量。
3. **等级判定**：
   - 遍历用户数据，将交易量与 VIP 门槛（8000, 5000, 2000, 1000）比对。
   - 确定用户应处的理论等级。
4. **链上同步**：
   - 调用合约读取用户当前的链上等级。
   - 若 **理论等级 ≠ 当前等级**，则构建交易调用 `setUserVipTier` 进行更新。
   - *优化策略*：可使用批量更新接口以节省 Gas。

------

## 5. 前端界面实施方案 (Frontend Layer)

### 5.1 交易页面 (Trade Page)

1. **费率展示**：在下单面板显示“当前费率”，并根据用户等级动态显示折扣（如划掉原价显示优惠价）。
2. **成本预估**：在下单确认弹窗中，基于当前 VIP 费率计算并显示“预计手续费”。

### 5.2 账户看板 (Account/Profile)

1. **VIP 徽章**：在用户头像旁显示当前 VIP 等级（如 VIP 3）。
2. **升级进度条**：
   - 可视化展示：`当前交易量 / 下一级门槛`。
   - 文案提示：“再交易 500 USD 即可升级 VIP 4，享受 5 折手续费！”。

### 5.3 邀请返佣中心 (/referral)

1. **邀请链接生成**：根据当前钱包地址生成专属链接（例如 `?ref=0x123...`）。
2. **绑定交互**：
   - 若用户通过带 `ref` 参数的链接进入，自动在本地缓存推荐人地址。
   - 提供手动输入框和“绑定”按钮，调用合约 `registerReferral`。
3. **数据仪表盘**：
   - 展示“我的邀请人数”。
   - 展示“累计获得返佣（MON）”。

------

## 6. 验收测试标准 (QA)

### 6.1 单元测试

- 验证 VIP 0 - VIP 4 不同等级扣费金额是否精确。
- 验证绑定推荐人后，手续费是否正确分流（90% 项目方 / 10% 推荐人）。
- 验证不能重复绑定或自我绑定。

### 6.2 集成测试

1. **升级流程**：模拟 Alice 交易量达到 1000 USD，触发 Keeper 运行，确认链上等级变为 VIP 1，且下一笔交易费率降低。
2. **跨级流程**：模拟 Bob 一次性交易 8000 USD，确认直接升至 VIP 4。
3. **返佣流程**：Alice 邀请 Bob，Bob 交易。确认 Alice 的保证金余额增加，且金额等于 Bob 手续费的 10%。

### 6.3 部署检查

- 确保 `FeeReceiver` 地址已配置且安全。
- 确保 VIP Keeper 拥有合约的 `OPERATOR_ROLE` 权限。